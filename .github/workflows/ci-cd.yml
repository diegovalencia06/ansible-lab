name: CI/CD - Ansible Deploy
on:
 push:
 branches: [ main ]
jobs:
 test:
 runs-on: ubuntu-latest
 steps:
 - name: Checkout
 uses: actions/checkout@v4
 - name: Set up Node.js
 uses: actions/setup-node@v4
 with:
 node-version: '18'
  - name: Install deps & run tests
 run: |
 cd app
 npm ci
 npm test
 deploy:
 needs: test
 runs-on: ubuntu-latest
 environment:
 name: production
 url: http://198.51.100.23 # opcional
 steps:
 - name: Checkout
 uses: actions/checkout@v4
 - name: Prepare SSH
 run: |
 mkdir -p ~/.ssh
 echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
 chmod 644 ~/.ssh/known_hosts
 echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
 chmod 600 ~/.ssh/id_rsa
 - name: Install Ansible
 run: |
 sudo apt update
 sudo apt install -y python3-pip sshpass
 python3 -m pip install --upgrade pip
 pip3 install ansible==8.11.0 # o la versi√≥n preferida
 - name: Run Ansible Playbook (deploy)
 env:
 GIT_REF: ${{ github.ref_name }}
 run: |
 cd ansible
 ansible-playbook playbooks/deploy.yml -i inventories/production.yml --sshcommon-args='-o StrictHostKeyChecking=no'
